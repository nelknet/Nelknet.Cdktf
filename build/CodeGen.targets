<Project>
  <PropertyGroup>
    <CodeGenTool>$(RepoRoot)tools/Nelknet.Cdktf.CodeGen/Nelknet.Cdktf.CodeGen.fsproj</CodeGenTool>
  </PropertyGroup>

  <Target Name="EnsureProviderGenerated" BeforeTargets="BeforeBuild" Condition="'$(ProviderId)' != '' and '$(EnableProviderCodeGen)' != 'false'">
    <PropertyGroup>
      <GeneratedOutputRoot Condition="'$(GeneratedOutputRoot)' == ''">$(MSBuildProjectDirectory)\Generated</GeneratedOutputRoot>
      <GeneratedFilePath Condition="'$(GeneratedFilePath)' == ''">$(GeneratedOutputRoot)\$(ProviderModule).Module.fs</GeneratedFilePath>
      <_CodeGenConfiguration Condition="'$(CodeGenConfiguration)' != ''">$(CodeGenConfiguration)</_CodeGenConfiguration>
      <_CodeGenConfiguration Condition="'$(_CodeGenConfiguration)' == '' and '$(Configuration)' != ''">$(Configuration)</_CodeGenConfiguration>
      <_CodeGenConfiguration Condition="'$(_CodeGenConfiguration)' == ''">Debug</_CodeGenConfiguration>
    </PropertyGroup>

    <Error Condition="!Exists('$(ProviderPackageDir)')" Text="Provider package directory '$(ProviderPackageDir)' not found. Run the provider ensure step first." />

    <PropertyGroup>
      <_NeedsCodeGen Condition="!Exists('$(GeneratedFilePath)')">true</_NeedsCodeGen>
    </PropertyGroup>

    <Exec Condition="'$(_NeedsCodeGen)' == 'true' OR '$(ForceCodeGen)' == 'true'"
          Command="dotnet run --project &quot;$(CodeGenTool)&quot; --configuration &quot;$(_CodeGenConfiguration)&quot; -- --provider-id &quot;$(ProviderId)&quot; --module-name &quot;$(ProviderModule)&quot; --namespace &quot;$(ProviderNamespace)&quot; --package-dir &quot;$(ProviderPackageDir)&quot; --output-root &quot;$(GeneratedOutputRoot)&quot;" />
  </Target>
</Project>
